---
title: "R Notebook"
output: html_notebook
---

## Load the libraries
```{r}


packages.used <- c(
  "tidyr",
  "tibble",
  "dplyr",
  "readr",
  "Quandl",
  "stringr"
)

packages.needed=setdiff(packages.used, 
                        intersect(installed.packages()[,1], 
                                  packages.used))

# install additional packages
if(length(packages.needed)>0){
  install.packages(packages.needed, dependencies = TRUE)
}


for (pkg in as.vector(packages.used)) {
  library(pkg, character.only = TRUE)
}

```

## Load the data
Subset a sample
```{r}
train <- read_csv(file = "../data/train.csv")
test <- read_csv(file = "../data/test.csv")
```

## Bind the train and test data for feature extraction
```{r}
master <- train[c(1, 3:29)] %>%
  bind_rows(test)
```


## Get just id and amenities
Separate the amenities from the training data and convert the amenities text into a list
```{r}
amenities <- master %>% 
  select(id, amenities) %>%
  mutate(amenities = str_to_lower(amenities)) %>%
  mutate(amenities = str_replace_all(amenities,"[{}\"]","")) 
```

## Get a unique list of amenities across all listings
We can see that there are 131 unique amenities in the training data.  Now we have to think about which ones might be most indicative of the price.
```{r}
possible_amenities <- amenities %>% 
  separate_rows(amenities, sep = ",") %>%
  select(amenities) %>%
  unique()
```

# Quandl API - Home Price Data

## Get zipcodes into separate data frame, reformatting zipcode for API query
We expect neighborhood home values to be closely related to listing price.  Therefore, we extract the zipcode from each listing (reformatting to use with Quandl API)
```{r}
zipcodes <- master %>% 
  select(id, zipcode) %>%
  mutate(zipcode = str_extract(zipcode, pattern = "[0-9]{5}"))

cities <- master %>%
  select(id,city)
```

## Six unique cities
```{r}
city_codes <- list(x = 1:length(cities.unique), y = c("city","code"))
for(i in 1:length(cities.unique)) {
  city_codes[i] <- cities.unique[i]
}

# codes manually inputted using quandl file `data/quandl_cities`
city_codes[[1]] <- "00002"
city_codes[[2]] <- "00012"
city_codes[[3]] <- "00008"
city_codes[[4]] <- "00003"
city_codes[[5]] <- "00004"
city_codes[[6]] <- "00011"

city_codes
```
```{r}


api_key <- Quandl.api_key("dWNtubCoGPAP6EtAwK1x")
area <- "ZILLOW/Z" # Use zip code to search
code <- "10026"
indicator <- "_ZRIAH" # Zillow rental index (all homes)

data <- quandl.api(path = str_c("datasets/",area, code, indicator), http = "GET")

```



## Query API
Get the unique zipcodes in our data set
```{r}
zipcodes.unique <- zipcodes %>%
  select(zipcode) %>%
  drop_na() %>%
  unique() %>%
  as.matrix()

cities.unique <- cities %>%
  select(city) %>%
  drop_na() %>%
  unique() 
```

```{r}

for(x in 1:length(zipcodes.unique)) { print(zipcodes.unique[x])}

```

```{r}


area <- "ZILLOW/Z" # Use zip code to search
indicator <- "_ZRIAH" # Zillow rental index (all homes)

rental_price = matrix(nrow = length(zipcodes.unique), ncol = 2)
for(i in 1: length(zipcodes.unique)) {
  zip <- zipcodes.unique[i]
  code <- str_c(area, zip, indicator)
  tryCatch(data <- Quandl(code = str_c(area, zip, indicator), rows = 1), finally = next())
  rental_price[i,1] <- zip
  rental_price[i,2] <- data$Value
}


```

```{r}

city <- "10026"
api_key <- Quandl.api_key()

area <- "ZILLOW/Z" # Use zip code to search
indicator <- "_ZRIAH" # Zillow rental index (all homes)
code <- str_c(area, city, indicator)
data <- Quandl(code = str_c(area, city, indicator), rows = 1)

rental_price[1,2] <- data$Value

```

