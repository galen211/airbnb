---
title: "R Notebook"
output: html_notebook
---
## Load the libraries
```{r}
packages.used <- c(
  "tidyr",
  "tibble",
  "dplyr",
  "readr",
  "Quandl",
  "stringr"
)

packages.needed=setdiff(packages.used, 
                        intersect(installed.packages()[,1], 
                                  packages.used))

# install additional packages
if(length(packages.needed)>0){
  install.packages(packages.needed, dependencies = TRUE)
}


for (pkg in as.vector(packages.used)) {
  library(pkg, character.only = TRUE)
}

```

## Load the data
Subset a sample
```{r warning=FALSE}
train <- read_csv(file = "../data/train.csv")
test <- read_csv(file = "../data/test.csv")
```

## Bind the train and test data for feature extraction
```{r}
master <- train[c(1, 3:29)] %>%
  bind_rows(test)
```


## Get just id and amenities
Separate the amenities from the training data and convert the amenities text into a list
```{r}
amenities <- master %>% 
  select(id, amenities) %>%
  mutate(amenities = str_to_lower(amenities)) %>%
  mutate(amenities = str_replace_all(amenities,"[{}\"]","")) 
```

## Get a unique list of amenities across all listings
We can see that there are 131 unique amenities in the training data.  Now we have to think about which ones might be most indicative of the price.
```{r}
possible_amenities <- amenities %>% 
  separate_rows(amenities, sep = ",") %>%
  select(amenities) %>%
  unique()
```

# Quandl API - Home Price Data

## Get zipcodes into separate data frame, reformatting zipcode for API query
We expect neighborhood home values to be closely related to listing price.  Therefore, we extract the zipcode from each listing (reformatting to use with Quandl API)
```{r}
zipcodes <- master %>% 
  select(id, zipcode) %>%
  mutate(zipcode = str_extract(zipcode, pattern = "[0-9]{5}"))
```

## Get Zillow data
Get the unique zipcodes in our data set
```{r}
zipcodes.unique <- zipcodes %>%
  select(zipcode) %>%
  drop_na() %>%
  unique()

zillowRentalIndex <- read_csv("../data/Zip_MedianRentalPrice_AllHomes.csv", 
                                col_types = cols(RegionName = col_character()))

zillowRentalIndex <- zillowRentalIndex %>%
  rename(rentalindex = `2017-12`) %>%
  rename(zipcode = RegionName)
```

## Join zillow data with our zipcodes
```{r}
rentalIndexByZip <- zillowRentalIndex %>%
  select(zipcode, rentalindex) %>%
  right_join(zipcodes.unique, by = c("zipcode" = "zipcode"))
```
