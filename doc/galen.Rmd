---
title: "R Notebook"
output: html_notebook
---

## Setup notebook execution
```{r setup}
knitr::opts_knit$set(root.dir = normalizePath("..")) 
```


## Load the libraries
```{r}
packages.used <- c(
  "tidyr",
  "tibble",
  "dplyr",
  "readr",
  "stringr",
  "zipcode",
  "geosphere",
  "sparklyr"
)

packages.needed=setdiff(packages.used, 
                        intersect(installed.packages()[,1], 
                                  packages.used))

# install additional packages
if(length(packages.needed)>0){
  install.packages(packages.needed, dependencies = TRUE)
}


for (pkg in as.vector(packages.used)) {
  library(pkg, character.only = TRUE)
}

```


```{r}
sc <- spark_connect(master = "local")
train <- spark_read_csv(header = TRUE, delimiter = ",", path = "data/train.csv")
test <- spark_read_csv(header = TRUE, delimiter = ",", path = "data/train.csv")
```

```{r}

train <- ft_string_indexer()

```


## Load the data
Subset a sample
```{r echo=FALSE, message=FALSE}
train <- read_csv(file = "data/train.csv")
test <- read_csv(file = "data/test.csv")
```

## Bind the train and test data for feature extraction
```{r}
master <- train[c(1, 3:29)] %>%
  bind_rows(test)
```

# Zipcodes - Home Price Data

```{r}
rentalPrice <- master %>% 
  select(id, zipcode) %>%
  mutate(zipcode = str_extract(zipcode, pattern = "[0-9]{5}"))
```

```{r}
unique_zipcodes <- rentalPrice %>%
  select(zipcode) %>%
  unique() %>%
  as.vector()
```

```{r}
source("lib/location_functions.R")
```

```{r}
n <- length(unique_zipcodes$zipcode)
m <- matrix(0, nrow = n, ncol = 1)
for (i in 1:n) {
  z <- unique_zipcodes$zipcode[i]
  m[i,1] <- getRentalIndex(z)
}
```


```{r}



filledRentalIndex <- unique_zipcodes %>%
  mutate(rentalIndex = getRentalIndex(zipcode))

```

```{r}
query_points <- zipcode %>%
    select(longitude, latitude) %>%
    as.matrix()
```

```{r}
charZip<-"10026"
zipWithData <- rentalIndex %>%
    select(zip)
  
  query_city <- getCityFromZip(charZip)
  
  query_points <- zipcode %>%
    filter(city == query_city) %>%
    select(longitude, latitude) %>%
    as.matrix()
  
  target_coord <- getCoordFromZip(charZip)
  m <- distm(target_coord, query_points)
  i <- which.min(m)
```

```{r}
rentalIndex[zip=="10026",]
```


```{r}
ind <- getRentalIndex("10040")
```


```{r}
query_points <- zipcode %>%
    subset(zip %in% unique_zipcodes) %>%
    select(longitude, latitude) %>%
    as.matrix()
```

```{r}
df <- zipcode[]
```


## Populate rental price index based on longitude / latitude distance
```{r}
ind <- getRentalIndex("10026")
print(ind)
```

# Amenities

## Get just id and amenities
Separate the amenities from the training data and convert the amenities text into a list
```{r}
amenities <- master %>% 
  select(id, amenities) %>%
  mutate(amenities = str_to_lower(amenities)) %>%
  mutate(amenities = str_replace_all(amenities,"[{}\"]","")) 
```

## Get a unique list of amenities across all listings
We can see that there are 131 unique amenities in the training data.  Now we have to think about which ones might be most indicative of the price.
```{r}
possible_amenities <- amenities %>% 
  separate_rows(amenities, sep = ",") %>%
  select(amenities) %>%
  unique()
```

```{r}

```


